# stable-diffusion-webui-sonar

    Tricks to improve the generated image quality, extension script for AUTOMATIC1111/stable-diffusion-webui

----

â„¹ This is the sister repo of [https://github.com/Kahsolt/stable-diffusion-webui-prompt-travel](https://github.com/Kahsolt/stable-diffusion-webui-prompt-travel), it focuses on **single prompt optimization** rather than traveling between multiple prompts. 

The core idea of Sonar is to search for similar (yet even better!) images in the **neighborhood** of some known image generated by a normal denoising process. 
Technically to do this, we hack into the samplers and sampling processing, do some tricks like:

  - momentum on latent difference
  - sample-wise optimzaton on prompt condition and image latent

to get image latents with higher quality (~perhaps!), and just pray again for good results ðŸ¤£


### Change Log

- 2022/11/18: add momentum mechanism


### Options

- prompt: (string)
- sampler: (categorical)
- momentum_*
  - momentum: (float), momentum of current latent difference
    - the larger, approving the current difference, (set `1.0` to **disable** momentum mechanism)
    - the smaller, approving the history difference momentum
  - momentum_hist: (float), momentum of memorized difference history
    - the larger, approving current history
    - the smaller, approving former histories
  - momentum_hist_init: (float), init value of history, aka. the genesis
    - `zero`: use the first denoised latent
    - `rand_init`: just use the init latent noise 
    - `rand_new`: use a new guassian noise
  - momentum_sign: (categorical), momentum direction to apply correction
    - `pos`: correct by direction of history momentum, affirming the history
    - `neg`: correct by opposite direction of history momentum, denying the history
    - `rand`: random choose from above at each sampling step
    - `pos_neg`: `pos` for the first half steps, then `neg` till the end
    - `neg_pos`: `neg` for the first half steps, then `pos` till the end
    - NOTE: option `neg` and `pos_neg` works well only if `momentum_hist` is enough large (`~0.9`)
- grad_*
  - grad_w_latent
  - grad_w_cond


### Installation

Easiest way to install it is to:
1. Go to the "Extensions" tab in the webui, switch to the "Install from URL" tab
2. Paste https://github.com/Kahsolt/stable-diffusion-webui-sonar.git into "URL for extension's git repository", click "install" button
3. Go to the "Installed" tab, click "Apply and Restart UI" button

Manual install:
1. Copy this repo folder to the 'extensions' folder of https://github.com/AUTOMATIC1111/stable-diffusion-webui
2. Go to the "Settings" tab, click "Restart Gradio and Refresh components" button


----

by Armit
2022/11/16 
